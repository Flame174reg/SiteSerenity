(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6532],{4178:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>h});var l=a(5155),n=a(2619),s=a.n(n),r=a(5239),i=a(2115);function o(e){let{defaultCategory:t,categories:a,forcedCategorySafe:n,onUploaded:s}=e,[r,o]=(0,i.useState)(null!=t?t:""),[c,d]=(0,i.useState)(!1),[u,f]=(0,i.useState)(null),h=(0,i.useRef)(null),m=!n;(0,i.useEffect)(()=>{t&&o(t)},[t]);let p=(0,i.useCallback)(async e=>{let t=new FormData;if(t.append("file",e,e.name),n)t.append("safe",n);else{let e=r.trim();if(!e)return alert("Укажите папку (категорию), либо откройте конкретную папку и загрузите туда."),!1;t.append("category",e)}let a=await fetch("/api/weekly/upload",{method:"POST",body:t}),l=await a.json();if(!l.ok){var s,i;return alert("Не удалось загрузить ".concat(e.name,": ").concat(null!=(i=null!=(s=l.error)?s:l.reason)?i:a.statusText)),!1}return!0},[r,n]),x=(0,i.useCallback)(async e=>{if(0===e.length)return;d(!0),f("Загружаем ".concat(e.length," шт..."));let t=0;try{for(let a of e){let l=await p(a);t+=Number(l),f("Загружено: ".concat(t," / ").concat(e.length))}t>0&&s&&s()}finally{d(!1),f(null)}},[p,s]);(0,i.useEffect)(()=>{function e(e){var t;let a=null==(t=e.clipboardData)?void 0:t.items;if(!a||0===a.length)return;let l=[];for(let e of a)if(e.type.startsWith("image/")){let t=e.getAsFile();t&&l.push(t)}l.length>0&&x(l)}return window.addEventListener("paste",e),()=>window.removeEventListener("paste",e)},[x]);let y=(0,i.useCallback)(async e=>{let t=e.target.files?Array.from(e.target.files):[];t.length>0&&await x(t),h.current&&(h.current.value="")},[x]);return(0,l.jsx)("div",{className:"rounded-xl border border-white/10 bg-white/5 p-3 mb-2",children:(0,l.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center gap-3",children:[(0,l.jsxs)("div",{className:"flex-1",children:[(0,l.jsx)("label",{className:"block text-sm text-white/70 mb-1",children:"Категория/папка"}),m?(0,l.jsx)("input",{className:"w-full rounded-md bg-white/10 border border-white/20 px-3 py-2 outline-none",placeholder:"Напр.: Апрель 2025",value:r,onChange:e=>o(e.target.value),list:a&&a.length?"weekly-categories":void 0}):(0,l.jsx)("input",{className:"w-full rounded-md bg-white/10 border border-white/20 px-3 py-2 outline-none",value:decodeURIComponent(n),disabled:!0}),a&&a.length>0&&(0,l.jsx)("datalist",{id:"weekly-categories",children:a.map(e=>(0,l.jsx)("option",{value:e},e))}),(0,l.jsx)("div",{className:"text-xs text-white/50 mt-1",children:"Можно создать новую папку, просто введя её имя. Поддерживается вставка из буфера (Ctrl/⌘+V)."})]}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("input",{ref:h,type:"file",accept:"image/*",multiple:!0,onChange:y,disabled:c}),(0,l.jsx)("button",{onClick:()=>{var e;return null==(e=h.current)?void 0:e.click()},disabled:c,className:"rounded-lg bg-white/10 hover:bg-white/15 border border-white/20 px-3 py-2 disabled:opacity-60",children:"Выбрать файлы"})]}),c&&(0,l.jsx)("div",{className:"text-sm text-white/70",children:u})]})})}function c(e){return"object"==typeof e&&null!==e}function d(e){return Array.isArray(e)?e:[]}function u(e){let t=c(e)?e:{},a=String("string"==typeof t.safe&&t.safe||"string"==typeof t.categorySafe&&t.categorySafe||"string"==typeof t.id&&t.id||""),l="string"==typeof t.name&&t.name||"string"==typeof t.categoryHuman&&t.categoryHuman||decodeURIComponent(a);return{safe:a,name:l||"Без названия",updatedAt:"string"==typeof t.updatedAt&&t.updatedAt||"string"==typeof t.lastModified&&t.lastModified||null,count:Number("number"==typeof t.count&&t.count||"number"==typeof t.items&&t.items||"number"==typeof t.total&&t.total||0)}}function f(e){if(!c(e))return[];let t=d(e.categories);if(t.length)return t;let a=d(e.albums);return a.length?a:[]}function h(){let[e,t]=(0,i.useState)([]),[a,n]=(0,i.useState)(!0),[d,h]=(0,i.useState)(null),[m,p]=(0,i.useState)(!1),[x,y]=(0,i.useState)(null),b=(0,i.useCallback)(async()=>{n(!0),h(null);try{let e=await fetch("/api/weekly/list",{cache:"no-store"}),a=await e.json(),l=f(a);if(!Array.isArray(l)||0===l.length)try{e=await fetch("/api/weekly/categories",{cache:"no-store"}),a=await e.json(),l=f(a)}catch(e){}let n=(l||[]).map(u);t(n)}catch(e){h("Не удалось загрузить список альбомов")}finally{n(!1)}},[]),g=(0,i.useCallback)(async()=>{try{var e;let t=await fetch("/api/photo/can-upload",{cache:"no-store"}),a=await t.json(),l=c(a)?a:{};p(!!(null!=(e=l.canUpload)?e:l.ok))}catch(e){p(!1)}},[]);(0,i.useEffect)(()=>{b(),g()},[b,g]);let w=(0,i.useCallback)(async e=>{var a;if(!m)return;let l=(null!=(a=window.prompt("Подпись альбома",e.name))?a:"").trim();if(l)try{y(e.safe);let a=await fetch("/api/weekly/folder/caption",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({safe:e.safe,name:l})}),n=await a.json().catch(()=>null);if(!(c(n)&&"boolean"==typeof n.ok&&n.ok)){let e=c(n)&&"string"==typeof n.error?n.error:a.statusText;alert("Не удалось сохранить подпись: ".concat(e));return}t(t=>t.map(t=>t.safe===e.safe?{...t,name:l}:t))}catch(e){alert(String(e))}finally{y(null)}},[m]),j=(0,i.useCallback)(async e=>{if(m&&confirm("Удалить альбом \xab".concat(e.name,"\xbb и все его фото?")))try{y(e.safe);let a="weekly/".concat(e.safe,"/"),l=await fetch("/api/weekly/folder/delete",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({prefix:a})}),n=await l.json().catch(()=>null);if(!(c(n)&&"boolean"==typeof n.ok&&n.ok)){let e=c(n)&&"string"==typeof n.error?n.error:l.statusText;alert("Не удалось удалить альбом: ".concat(e));return}t(t=>t.filter(t=>t.safe!==e.safe))}catch(e){alert(String(e))}finally{y(null)}},[m]),v=(0,i.useCallback)(e=>{if(!e)return"—";try{return new Date(e).toLocaleString("ru-RU")}catch(t){return e}},[]);return(0,l.jsxs)("div",{className:"mx-auto max-w-6xl",children:[(0,l.jsxs)("div",{className:"mb-3 flex items-center justify-between",children:[(0,l.jsx)("h1",{className:"text-2xl font-semibold",children:"Недельный актив"}),(0,l.jsx)(s(),{href:"/weekly/all",className:"underline text-white/70 hover:text-white",children:"Показать все фото"})]}),(0,l.jsx)("p",{className:"mb-4 text-white/70",children:"Тут Вы можете увидеть свой актив/явку за неделю. Выберите папку или создайте новую. Также можно загрузить фото сразу, указав название новой папки — она будет создана автоматически."}),(0,l.jsx)(o,{categories:e.map(e=>e.name),onUploaded:b}),a&&(0,l.jsx)("div",{className:"mt-4 text-white/70",children:"Загружаем альбомы…"}),!a&&d&&(0,l.jsx)("div",{className:"mt-4 text-red-400",children:d}),!a&&!d&&0===e.length&&(0,l.jsx)("div",{className:"mt-4 text-white/70",children:"Альбомов пока нет."}),!a&&!d&&e.length>0&&(0,l.jsx)("ul",{className:"mt-6 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3",children:e.map(e=>(0,l.jsxs)("li",{className:"relative overflow-hidden rounded-2xl border border-white/10 bg-white/5 p-0",children:[(0,l.jsx)(s(),{href:"/weekly/".concat(encodeURIComponent(e.safe)),children:(0,l.jsx)("div",{className:"relative h-40 w-full",children:(0,l.jsx)(r.default,{src:"https://i.ibb.co/TBZ5CXFW/logo.png",alt:e.name,fill:!0,className:"object-cover",priority:!0,sizes:"(max-width: 768px) 100vw, 33vw"})})}),(0,l.jsxs)("div",{className:"p-4",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsx)(s(),{href:"/weekly/".concat(encodeURIComponent(e.safe)),className:"truncate font-semibold hover:underline",children:e.name}),(0,l.jsx)("span",{className:"shrink-0 rounded-full bg-white/10 px-2 py-0.5 text-xs",children:e.count})]}),(0,l.jsxs)("div",{className:"mt-2 text-xs text-white/60",children:["обновлено: ",v(e.updatedAt)]})]}),m&&(0,l.jsxs)("div",{className:"absolute right-3 top-3 z-10 flex gap-2",children:[(0,l.jsx)("button",{disabled:x===e.safe,onClick:()=>w(e),className:"rounded-md bg-white/90 px-2 py-1 text-xs text-black hover:bg-white disabled:opacity-60",title:"Изменить подпись",children:"Подпись"}),(0,l.jsx)("button",{disabled:x===e.safe,onClick:()=>j(e),className:"rounded-md bg-red-500/90 px-2 py-1 text-xs text-white hover:bg-red-500 disabled:opacity-60",title:"Удалить альбом",children:"Удалить"})]})]},e.safe))})]})}},8909:(e,t,a)=>{Promise.resolve().then(a.bind(a,4178))}},e=>{e.O(0,[2619,5239,8441,1255,7358],()=>e(e.s=8909)),_N_E=e.O()}]);