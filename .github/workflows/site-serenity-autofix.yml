name: SiteSerenity Autofix

on:
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  autofix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure next-auth type augmentation
        run: |
          mkdir -p src/types
          cat > src/types/next-auth.d.ts <<'EOF'
          import { DefaultSession } from "next-auth";

          declare module "next-auth" {
            interface Session {
              accessToken?: string;
              discordId?: string;
              user: {
                id?: string;
              } & DefaultSession["user"];
            }
          }

          declare module "next-auth/jwt" {
            interface JWT {
              accessToken?: string;
              discordId?: string;
            }
          }

          export {};
EOF

      - name: Ensure tsconfig include
        run: |
          if [ -f tsconfig.json ]; then
            node - <<'NODE'
            const fs = require('fs');
            const path = 'tsconfig.json';
            const json = JSON.parse(fs.readFileSync(path, 'utf8'));
            json.include = json.include || [];
            if (!json.include.includes('src/types/**/*.d.ts')) {
              json.include.push('src/types/**/*.d.ts');
            }
            fs.writeFileSync(path, JSON.stringify(json, null, 2) + '\n');
NODE
          else
            echo "tsconfig.json not found, skipping"
          fi

      - name: Replace session.discordId usage
        run: |
          git grep -l "session\.discordId" -- 'src/*' || true
          git grep -l "session\.discordId" -- 'src/*' | xargs -r sed -i 's/session\.discordId/session.user?.id/g'

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'chore: autofix next-auth types and session.user.id'
          title: 'Autofix: next-auth types and session.user.id'
          branch: autofix/next-auth
          delete-branch: true
          body: |
            Автофикс:
            - добавлен src/types/next-auth.d.ts (JWT/Session augmentation)
            - tsconfig.json включает "src/types/**/*.d.ts"
            - заменены все session.discordId -> session.user?.id
